---
title: "Get started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Get started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
library(pbwrangler)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_full.Rmd: do not edit by hand -->


<!-- Run this 'development' chunk -->
<!-- Store every call to library() that you need to explore your functions -->

<!--
 You need to run the 'description' chunk in the '0-dev_history.Rmd' file before continuing your code there.

If it is the first time you use {fusen}, after 'description', you can directly run the last chunk of the present file with inflate() inside.
--> 

<!-- # Include some data examples in your package -->

<!-- 
 Store your dataset in a directory named "inst/" at the root of your project.
 Use it for your tests in this Rmd thanks to `pkgload::load_all()` to make it available
and `system.file()` to read it in your examples.

- There already is a dataset in the "inst/" directory to be used in the examples below
-->


## Substring first n elements

<!--
Create a chunk for the core of the function

- The chunk needs to be named `function` at least
- It contains the code of a documented function
- The chunk can also be named `function-my_median` to make it easily
findable in your Rmd
- Let the `@examples` part empty, and use the next `examples` chunk instead to present reproducible examples

After inflating the template

-  This function code will automatically be added in a new file in the "R/" directory
-->


<!--
Create a chunk with an example of use for your function

- The chunk needs to be named `examples` at least
- It contains working examples of your function
- The chunk is better be named `examples-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This example will automatically be added in the '@examples' part of our function above in the "R/" directory
- This example will automatically be added in the vignette created from this Rmd template
-->
```{r examples}
#| message: no
#| warning: no

a <- c("asdf", "bnmkk")
my_left(a, num = 3)
```


```{r examples-my_right}
#| message: no
#| warning: no

a <- c("asdf", "bnmkk")
my_right(a, num = 3)
```


```{r examples-drop_nas}
#| message: no
#| warning: no

df <- data.frame(a = NA, b = c(1:3, NA), c = 0)
drop_nas(df)
drop_zeros(df)

```


## clean directory/file names

Clean file names from a directory using `clean_dir_name()`


```{r examples-clean_dir_name}
#| message: no
#| warning: no


f <- system.file("uon-trial-1.csv", package = "pbwrangler")
clean_dir_name(f)
```






## List files

List files in a directory using `list_files()`




```{r examples-list_file}
#| message: no
#| warning: no


list_files(system.file(package = "pbwrangler"))[1:5]
```




<!--
Create a chunk with a test of use for your function

- The chunk needs to be named `tests` at least
- It contains working tests of your function
- The chunk is better be named `tests-my_median` to be handled
correctly when inflated as a vignette

After inflating the template

-  This test code will automatically be added in the "tests/testthat/" directory
-->

## Compare dataframes to find shared columns 

If you suspect two fieldbooks to be similar, you can compare them.

```{r examples-compare_df}
#| message: no
#| warning: no


f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir=NULL, file_to_read = f)[[1]]
f1 <- system.file("uon-trial-1.xlsx", package = "pbwrangler")
df1 <- read_workbooks(dir=NULL, file_to_read = f, sheet_name = "Sheet1")[[1]]
compare_df(df, df1)
```



## Merge notes/obs to one column

```{r examples-merge_note_obs}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir=NULL, file_to_read = f)[[1]]
merge_note_obs(df)[1:5, "obs"]
```



## Create a meta-data file for each experiment designed during a season

Create a meta-data to accompany fieldbooks.

```{r examples-create_meta_file}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f)
create_meta_file(df, season = "season-2024", d_dir = tempdir())
```



## Capture trial location

You could try capture trial location from file names:

```{r examples-capture_location}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.xlsx", package = "pbwrangler")
f1 <- system.file("uon-trial-1.csv", package = "pbwrangler")

df <- read_workbooks(dir = NULL, file_to_read = f, sheet_name = "Sheet 1")
df1 <- read_workbooks(dir = NULL, file_to_read = f1)

dat <- c(df, df1)
# this has a loc variable
dat_loc <- capture_location(dat)
lapply(dat_loc, function(x) x$loc[1:5])
```






## write data

You can write trial data using `write_data()`:

```{r examples-write_data}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.xlsx", package = "pbwrangler")
f1 <- system.file("uon-trial-1.csv", package = "pbwrangler")

df <- read_workbooks(dir = NULL, file_to_read = f, sheet_name = "Sheet 1")
df1 <- read_workbooks(dir = NULL, file_to_read = f1)
dat <- c(df, df1)

write_data(dir = tempdir(), data_list = dat, season = "season-2024")
```







## create genotype family codes

You can also create family codes from accession names using `create_family_vars()`.

```{r examples-create_family_vars}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.xlsx", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f, sheet_name = "Sheet 1") %>%
  capture_location(.) %>% `[[`(1)

create_family_vars(df)[1:5, ]

```



## clean clone/genotype names

## read accession files that have been fixed and confirmed correct



## organize accessions for export

## recode variables

Parse variables from one type to another using `recode_var()`.

```{r examples-recode_var}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>% `[[`(1)
df_c <- recode_var(df)
```









## run routine data checks

Run data checks using st4gi package and compute derived columns 

```{r examples-run_checks}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>%
  `[[`(1)
df_checked <- run_checks(df)
```



## check accession names

Check accession names using `check_geno()`.




```{r examples-check_geno}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) 
df_checked <- check_geno(df)
```




## update accession names

Update accession names with `update_geno()`

```{r examples-update_geno}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>%
  `[[`(1)
df_checked <- update_geno(df)
```



## rename columns

Rename variables to match ontology lables with `rename_cols()`

```{r examples-rename_cols}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>%
  `[[`(1)
df <- rename_cols(df)
```



## process trial data

Apply a number of data cleaning functions to trial data with `pre_process_trials()`




A number of computed columns are generated in the process.
```{r examples-pre_process_trials}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) 
df_out <- pre_process_trials(df) |> process_trials() %>%
  purrr::map(., run_data_processes)
purrr::map(df_out, names_df)
```




## Create a trial design object for row-col design

Create a trial design object, fit model and extract predictions





```{r examples-create_td}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>%
  purrr::map(
    ., ~dplyr::mutate(
      ., year = "2024", loc = "UON", trial = "lbht"
    )
  )
df_out <- pre_process_trials(df) |> process_trials() %>%
  purrr::map(., run_data_processes) %>% `[[`(1) 
# trial design object
TD <- create_td(df_out, design = "rowcol")
# fit 
fit_TD <- fit_td(TD, trait = "atw")
# extract predictions

pred_TD <- extract_blups(fit_TD, pred = c("BLUEs", "seBLUEs"))

pred_TD[[1]][1:5,]

```




## get in/valid column names 

Get invalid columns (labels not defined in ontology)

```{r examples-subset_invalid_cols}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
df <- read_workbooks(dir = NULL, file_to_read = f) %>%
  purrr::map(
    ., ~dplyr::mutate(
      ., year = "2024", loc = "UON", trial = "lbht"
    )
  )
df_out <- pre_process_trials(df) |> process_trials() %>%
  purrr::map(., run_data_processes) %>% `[[`(1) 

subset_invalid_cols(df_out) %>% colnames(.)
```





## tissue culture helpers




## read trial data files

```{r examples-read_workbooks}
#| message: no
#| warning: no

f <- system.file("uon-trial-1.csv", package = "pbwrangler")
d <- read_workbooks(dir = NULL, file_to_read = f)
lapply(d, function(x) x[1:5, 1:5])
```




field trial randomization

## partially replicated (prep) design




```{r examples-geno_by_tubers}
#| message: no
#| warning: no

data("ilri", package = "pbwrangler")
ins_ilri <- geno_by_tubers(ilri)
lapply(ins_ilri, head, 5)
```



Do partially replicated randomization
```{r examples-rand_Prep}
#| message: no
#| warning: no

d <- tempdir()
data("ilri", package = "pbwrangler")
ins_ilri <- geno_by_tubers(ilri)
ilri_prep <- rand_Prep(
  tot = 53,
  ins = ins_ilri,
  rowD = 12,
  trial = "ilri",
  n_dummies = 5,
  loc = "ilri",
  totReps =96,
  trtrepP = trial_design_meta()$trep,
  trtgroup = trial_design_meta()$trgroup,
  block_lst = trial_design_meta()$block_list,
  path = NULL
)
head(ilri_prep)
```



## rowcol design

rowcol design for 4 genotypes with 2 checks
```{r examples-randomize_row_col}
#| message: no
#| warning: no

df <- data.frame(geno = LETTERS[1:4])
rcD <-
  randomize_row_col(
    clones = df,
    tot = 6,
    rowD = 6,
    n_dummies = 0,
    to_add = 2,
    rep = 3,
    path = NULL
  )
head(rcD)
```



<!-- # Calculate the mean of a vector -->

<!--
There can be other functions, examples and tests in your flat template.
Each of them will be inflated in a different file, provided that there is a level-1 or level-2 section title to separate from previous functions.
-->

<!-- ## Use sub-functions in the same chunk -->



<!--
# There can be development actions

Create a chunk with 'development' actions

- The chunk needs to be named `development` or `dev`
- It contains functions that are used for package development only
- Note that you may want to store most of these functions in the 0-dev_history.Rmd file

These are only included in the present flat template file, their content will not be part of the package anywhere else.
-->


<!-- # Inflate your package -->

<!-- You're one inflate from paper to box. -->
<!-- Build your package from this very Rmd using `fusen::inflate()` -->

<!-- - Verify your `"DESCRIPTION"` file has been updated -->
<!-- - Verify your function is in `"R/"` directory -->
<!-- - Verify your test is in `"tests/testthat/"` directory -->
<!-- - Verify this Rmd appears in `"vignettes/"` directory -->
